<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <link rel="stylesheet" type="text/css" href="trix.css">
    <script type="text/javascript" src="trix.js"></script>
    <style media="screen">
      .html-editor-textarea {
        width: 96%;
        height: 180pt;
      }
      #html-editor-cnt {
        position: fixed;
        bottom: 0px;
        width: 100%;
        z-index: 10;
        max-height: 200pt;
        background-color: white;
        border-top: gray;
        border-style: double;
        border-width: 2pt 0 0 0;
        margin: 0;
        padding: 10pt;
      }
      #html-editory-bottom-spacer {
        height: 250pt
      }
      trix-editor {
        max-height: 140pt;
        overflow: auto;
      }
      body {
        margin: 0;
      }
      #display {
        padding: 8pt;
      }
    </style>
    <style media="screen" id='user-style'></style>
  </head>
  <body>
    <div id='display'></div>
    <div id='html-editory-bottom-spacer'></div>


    <div id='html-editor-cnt'>
      <div id='radio-cnt'>
        <label>Trix</label>
        <input type="radio" name="display" value="trix" checked>
        <label>Html</label>
        <input type="radio" name="display" value="html">
        <label>Css</label>
        <input type="radio" name="display" value="css">
      </div>

      <div id='trix-cnt' class='html-editor-textarea'>
        <trix-editor></trix-editor>
      </div>
      <textarea class='html-editor-textarea' id='raw-html-input' hidden></textarea>
      <textarea class='html-editor-textarea' id='css-input' hidden></textarea>
    </div>
    <script type="text/javascript">
      var element = document.querySelector("trix-editor")
      element.editor  // is a Trix.Editor instance
      let html;
      let state = 'trix';
      const display = document.getElementById('display');
      const checkbox = document.getElementById('raw-html');
      const rawInput = document.getElementById('raw-html-input');
      const trixCnt = document.getElementById('trix-cnt');
      const cssInput = document.getElementById('css-input');
      const userStyle = document.getElementById('user-style');
      const radioCnt = document.getElementById('radio-cnt');
      let maxTextLength = 81;
      let css = '';

      function tabText(tabStr, text) {
        text = text.replace(/\n/g, `\n${tabStr}`);
        const mtl = maxTextLength - tabStr.length;
        let formatStr = '';
        let currIndex = 0;
        let startIndex = 0;
        let endIndex = text.indexOf(' ');
        let index;
        while ((index = text.indexOf(' ', currIndex)) !== -1) {
          if (index - startIndex < mtl) {
            endIndex = index;
            currIndex = index + 1;
          } else {
            formatStr += `\n${tabStr}${text.substring(startIndex, endIndex)}`;
            startIndex = endIndex + 1;
            endIndex = text.indexOf(' ', startIndex);
            currIndex = startIndex;
          }
        }
        if (text.length - startIndex < mtl) formatStr += `\n${tabStr}${text.substring(startIndex, text.length)}`;
        else if (endIndex !== -1) formatStr += `\n${tabStr}${text.substring(startIndex, endIndex)}\n${tabStr}${text.substring(endIndex + 1, text.length)}`;
        else formatStr += `\n${tabStr}${text.substring(startIndex, text.length)}`;
        return formatStr.substring(1);
      }

      const tagReg = /^(.*?)((<[a-zA-Z0-9]{1,}.*?>)|(<\/[a-zA-Z0-9]{1,}>))/;
      const tab = (count) => new Array(count).fill('  ').join('');
      const elementReg = /^([^>^<]*?)(<([a-zA-Z-0-9]*)[^>]*>((?!(<\3[^>]*>|<\/\3>)).)*<\/\3>)/;
      const multiSpaceReg = / {2,}/g;
      function formatHtml(str) {
        if ((typeof str) !== 'string') return '';
        let formattedStr = '';
        let index = 0;
        let nestCnt = 0;
        let currStr = str.replace(/\n/g, '');
        let match;
        while (match = currStr.match(tagReg)) {
          const currTab = tab(nestCnt);
          const elemMatch = currStr.match(elementReg);
          const hasClosingTag = currStr.indexOf(`${match[2][0]}/${match[2].substring(1)}`) !== -1;
          const prefix = match[1].trim() ? `\n${tabText(currTab, match[1].trim().replace(multiSpaceReg, ' '))}` : '';
          const tagStr = elemMatch ? elemMatch[2].trim().replace(multiSpaceReg, ' ') : undefined;
          if (tagStr && tagStr.length + currTab.length < maxTextLength) {
            formattedStr += `${prefix}\n${currTab}${tagStr}`;
            currStr = currStr.substring(elemMatch[1].length + elemMatch[2].length);
          } else if (match[3]) {
            formattedStr += `${prefix}\n${currTab}${match[3].trim().replace(multiSpaceReg, ' ')}`;
            if (hasClosingTag) nestCnt++;
            currStr = currStr.substring(match[1].length + match[2].length);
          } else {
            formattedStr += `${prefix}\n${tab((nestCnt || 1) - 1)}${match[4].trim().replace(multiSpaceReg, ' ')}`;
            nestCnt += nestCnt ? -1 : 0;
            currStr = currStr.substring(match[1].length + match[2].length);
          }
        }
        return (formattedStr + currStr).replace(/>( {2,})</g, '> <');
      }

      rawInput.addEventListener('keyup', (e) => {
        if (state !== 'html' || rawInput.value === html) return;
        radioCnt.children[0].hidden = true;
        radioCnt.children[1].hidden = true;
        html = rawInput.value;
        display.innerHTML = html;
      });

      element.addEventListener('keyup', (e) => {
        if (state !== 'trix') return;
        html = e.target.value;
        display.innerHTML = html;
      });
      cssInput.addEventListener('keyup', (e) => {
        css = e.target.value;
        userStyle.innerHTML = css;
      });
      radioCnt.addEventListener('click', (e) => {
        state = document.querySelector('input[type=\'radio\']:checked').value;
        if (state === 'trix') {
          trixCnt.hidden = false;
          rawInput.hidden = true;
          cssInput.hidden = true;
          const docLen = element.editor.getDocument().getLength();
          element.editor.setSelectedRange([0, docLen])
          element.editor.insertHTML(html);
        } else if (state === 'html') {
          trixCnt.hidden = true;
          rawInput.hidden = false;
          cssInput.hidden = true;
          rawInput.value = formatHtml(html);
          html = rawInput.value;
        } else {
          trixCnt.hidden = true;
          rawInput.hidden = true;
          cssInput.hidden = false;
        }
      });

      window.onload = () => {
        const toolbar = document.querySelector('trix-toolbar');
        toolbar.addEventListener('click', () => {
          html = element.value;
          display.innerHTML = html;
        });
      }
    </script>
  </body>
</html>
