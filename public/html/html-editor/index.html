<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <link rel="stylesheet" type="text/css" href="trix.css">
    <script type="text/javascript" src="trix.js"></script>
    <style media="screen">
      .html-editor-textarea {
        width: 100%;
        height: 100pt;
      }
    </style>
    <style media="screen" id='user-style'></style>
  </head>
  <body>
    <div id='display'></div>

    <div id='radio-cnt'>
      <label>Trix</label>
      <input type="radio" name="display" value="trix" checked>
      <label>Html</label>
      <input type="radio" name="display" value="html">
      <label>Css</label>
      <input type="radio" name="display" value="css">
    </div>

    <div id='trix-cnt'>
      <trix-editor></trix-editor>
    </div>
    <textarea class='html-editor-textarea' id='raw-html-input' hidden></textarea>
    <textarea class='html-editor-textarea' id='css-input' hidden></textarea>
    <script type="text/javascript">
      var element = document.querySelector("trix-editor")
      element.editor  // is a Trix.Editor instance
      let html;
      let state = 'trix';
      const display = document.getElementById('display');
      const checkbox = document.getElementById('raw-html');
      const rawInput = document.getElementById('raw-html-input');
      const trixCnt = document.getElementById('trix-cnt');
      const cssInput = document.getElementById('css-input');
      const userStyle = document.getElementById('user-style');
      const radioCnt = document.getElementById('radio-cnt');
      let css = '';

      const tagReg = /^(.*?)((<[a-zA-Z0-9]{1,}.*?>)|(<\/[a-zA-Z0-9]{1,}>))/;
      const tab = (count) => new Array(count).fill('  ').join('');
      const elementReg = /^([^>^<]*?)(<([a-zA-Z-0-9]*)[^>]*>((?!(<\3[^>]*>|<\/\3>)).)*<\/\3>)/;
      const multiSpaceReg = / {2,}/g;
      function formatHtml(str) {
        let formattedStr = '';
        let index = 0;
        let nestCnt = 0;
        let currStr = str.replace(/\n/g, '');
        let match;
        while (match = currStr.match(tagReg)) {
          console.log(match);
          const currTab = tab(nestCnt);
          const elemMatch = currStr.match(elementReg);
          const hasClosingTag = elemMatch !== null;
          const prefix = match[1].trim() ? `\n${currTab}${match[1].trim().replace(multiSpaceReg, ' ')}` : '';
          const tagStr = hasClosingTag ? elemMatch[2].trim().replace(multiSpaceReg, ' ') : undefined;
          if (hasClosingTag && tagStr.length + currTab.length < 81) {
            formattedStr += `${prefix}\n${currTab}${tagStr}`;
            currStr = currStr.substring(elemMatch[1].length + elemMatch[2].length);
          } else if (match[3]) {
            formattedStr += `${prefix}\n${currTab}${match[3].trim().replace(multiSpaceReg, ' ')}`;
            if (hasClosingTag) nestCnt++;
            currStr = currStr.substring(match[1].length + match[2].length);
          } else {
            formattedStr += `${prefix}\n${tab((nestCnt || 1) - 1)}${match[4].trim().replace(multiSpaceReg, ' ')}`;
            nestCnt += nestCnt ? -1 : 0;
            currStr = currStr.substring(match[1].length + match[2].length);
          }
        }
        return (formattedStr + currStr).replace(/>( {2,})</g, '> <');
      }

      rawInput.addEventListener('keyup', (e) => {
        if (state !== 'html') return;
        html = rawInput.value;
        display.innerHTML = html;
      });

      element.addEventListener('keyup', (e) => {
        if (state !== 'trix') return;
        html = e.target.value;
        display.innerHTML = html;
      });
      cssInput.addEventListener('keyup', (e) => {
        css = e.target.value;
        userStyle.innerHTML = css;
      });
      radioCnt.addEventListener('click', (e) => {
        state = document.querySelector('input[type=\'radio\']:checked').value;
        if (state === 'trix') {
          trixCnt.hidden = false;
          rawInput.hidden = true;
          cssInput.hidden = true;
          const docLen = element.editor.getDocument().getLength();
          element.editor.setSelectedRange([0, docLen])
          element.editor.insertHTML(html);
        } else if (state === 'html') {
          trixCnt.hidden = true;
          rawInput.hidden = false;
          cssInput.hidden = true;
          rawInput.value = formatHtml(html);
        } else {
          trixCnt.hidden = true;
          rawInput.hidden = true;
          cssInput.hidden = false;
        }
      });
    </script>
  </body>
</html>
