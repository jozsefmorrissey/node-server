<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <script type="text/javascript" src='/js/utils/dom-utils.js'></script>
    <script type="text/javascript" src='/js/utils/string-math-evaluator.js'></script>
    <script type="text/javascript" src='/js/utils/custom-event.js'></script>
    <script type="text/javascript" src='/js/utils/expression-definition.js'></script>
    <script type="text/javascript" src='/js/utils/$t.js'></script>

    <script type="text/javascript">

      function parseList(str) {
        return str.split(',').map((s => s.trim()));
      }
      parseList.regex = /.{1,}?,.{1,}/;
      function parseValue(str) {
        return Number.parseFloat(str);
      }
      parseValue.regex = StringMathEvaluator.decimalReg;
      function parseEquation(str) {

      }
      const lineReg = /(.{1,}?)=(.*)/;
      const varReg = /[a-zA-Z]{1}[a-zA-Z0-9]*/g;
      let startKey;
      function parseLine(line, obj) {
        const match = line.match(lineReg);
        if (match === null) return;
        const key = match[1].trim();
        const value = match[2];
        if (startKey === undefined) startKey = key;
        if (value.match(parseList.regex)) obj[key] = parseList(value);
        else if (value.match(parseValue.regex)) obj[key] = parseValue(value);
        else {
          const sme = new StringMathEvaluator(value);
          const variables = value.match(varReg);
          obj[key] = {variables};
        }
      }

      const sme = new StringMathEvaluator();
      const chosen = {drawerBottom: 'include', bottomSelection: 'mapleA4QuarterInch'};
      function display(obj, startKey) {
        let keys = [startKey];
        const keysFound = {};
        const choices = [];
        let keyIndex = 0;
        while (keyIndex < keys.length) {
          const key = keys[keyIndex];
          if (keysFound[key] === undefined) {
            const value = obj[key];
            if (Array.isArray(value)) {
              choices.push({key, value});
              const chose = chosen[key];
              if (obj[chose] !== undefined && !Number.isFinite(obj[chose])) keys.push(chose);
            } else if (value instanceof Object && value.variables) {
              keys = keys.concat(value.variables);
            } else if (Number.isFinite(value)) {
              choices.push({key, checkbox: true});
            } else {
              choices.push({key, number: true});
            }
            keysFound[key] = true;
          }
          keyIndex++;
        }
        console.log(choices);
      }
      let obj;
      window.onload = () => {
        const text = document.querySelector('#input').value;
        obj = {};
        const lines = text.split('\n');
        lines.forEach((l) => parseLine(l, obj));
        console.log(obj);
        display(obj, startKey);
      }
    </script>
    <meta charset="utf-8">
    <title>Demo eqn</title>
  </head>
  <body>
    <textarea id='input'>
    drawerBox=(width * depth * 2 * height / 144 * woodSpecies) + drawerBottom + assembly + roundOver + notchAndDrill + brandInside + PIpulloutOptions
    drawerBottom=include,noThankYou
    include=(width * length / 144 * bottomSelection)
    noThankYou=0
    bottomSelection=mapleA4QuarterInch,mapleB1HalfInch
    mapleA4QuarterInch=2.00
    mapleB1HalfInch=3.00


    roundOver=3.00
    notchAndDrill=1.50
    brandInside=1.50

    assembly=unassembledWithOutBottom,unassembledWithBottom,assembledUnfinished,assembledPrefinished1Topcoat,assembledPrefinished2Topcoats
    unassembledWithOutBottom=6.00
    unassembledWithBottom=8.00
    assembledUnfinished=10.00
    assembledPrefinished1Topcoat=16.00
    assembledPrefinished2Topcoats=20.00

    woodSpecies=whiteSoftMapel,redOak,selectWalnut,rusticWalnut,bassWood,balticBirtch
    whiteSoftMapel=6.00
    redOak=5.50
    selectWalnut=11.00
    rusticWalnut=7.00
    bassWood=5.00
    balticBirtchPlywood=3.50

    PIpulloutOptions=standardScoop,scallopedSided,fullDovetailPlumingNotch,signatureTrashRollout,cornerDrawersWithDovetail
    standardScoop=3.00
    scallopedSided=5.00
    fullDovetailPlumingNotch=35.00
    signatureTrashRollout=30.00
    cornerDrawersWithDovetail=40.00

    height>17=*2.75
    height>8=*????
    </textarea>
  </body>
</html>
