<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <script type="text/javascript" src='/js/utils/dom-utils.js'></script>
    <script type="text/javascript" src='/js/utils/utils.js'></script>
    <script type="text/javascript" src='/js/utils/measurment.js'></script>
    <script type="text/javascript" src='/js/utils/request.js'></script>
    <script type="text/javascript" src='/js/utils/string-math-evaluator.js'></script>
    <script type="text/javascript" src='/pssst/js/pssst-client.js'></script>
    <style>
      #error-cnt {
        color: red;
      }
      .percision-input {
        max-width: 30pt;
      }
      .eq-input-elem {
        max-width: 45pt;
      }
    </style>
    <title>equations</title>
    <script type="text/javascript">
      let index = 1;
      const eval = new StringMathEvaluator(Math);
      function addEq(name, equation) {
        name = name || '';
        equation = equation || '';
        saved[index] = saved[index] || {};
        const newElem = du.create.element('div', {index: index});
        newElem.innerHTML = `<b>${index++}.)</b>
                              <input class='name' type='text' placeholder="Name" value='${name}'>
                              <input class='equation' type='text' placeholder="Equation" value='${equation}'>
                              <span class='input-cnt'></span>
                              <b>=</b>
                              <span class='answer-cnt'></span>
                              <br/>`;
        updateVariables(newElem.querySelector('.equation'));
        du.find('#eq-cnt').append(newElem);
      }

      function onlyUnique(value, index, self) {
        return self.indexOf(value) === index;
      }

      let saved = {};
      const c = 'eq-input-elem';
      function updateVariables(target) {
        let matches = target.value.match(/[a-z_A-Z][a-z_A-Z0-9]*/g);
        const varIndex = du.find.up('[index]', target).getAttribute('index');
        const inputCnt = du.find.closest('.input-cnt', target);
        if (matches) {
          matches = matches.filter(onlyUnique);
          let repeatHtml = '<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
          for (let index = 0; index < matches.length; index += 1) {
            const name = matches[index];
            const value = saved[varIndex][name] || 0;
            const div = du.create.element('span');
            const b = du.create.element('b');
            b.innerText = name;
            div.append(b);
            div.append(du.create.element('input', {class: c, value, name}));
            repeatHtml += '&nbsp;' + div.outerHTML;
          }
          inputCnt.innerHTML = repeatHtml;
        } else {
          inputCnt.innerHTML = '';
        }
        evaluate(target);
      }

      function evalConnected(index) {
        const eqns = du.find.all('.equation');
        const refReg = new RegExp(`\\$\\(${index}\\)`);
        for (let i = 0; i < eqns.length; i += 1) {
          let eqnStr = eqns[i].value;
          const vars = du.find.downAll('.eq-input-elem', eqns[i]);
          for (let j = 0; j < vars; vars += 1) {
            eqnStr += vars.value;
          }
          if (eqnStr.match(refReg)) {
            evaluate(eqns[i]);
          }
        }
      }

      let answers = [];
      let percision = 32;

      const $ = (index) => answers[index] || 0;
      function evaluate(target) {
        const index = du.find.up('[index]', target).getAttribute('index');
        const equation = du.find.closest('.equation', target).value;
        const inputCnt = du.find.closest(`.input-cnt`, target);
        const inputs = du.find.downAll('input', inputCnt);
        const scope = {$};
        for (let index = 0; index < inputs.length; index += 1) {
          const input = inputs[index];
          scope[input.name] = eval.eval(input.value, scope);
        }
        let value = eval.eval(equation, scope);
        if (percision !== undefined) {
          value = new Measurement(value).fraction(`1/${percision}`);
        }
        answers[index] = eval.eval(value);
        evalConnected(index);
        du.find.closest('.answer-cnt', target).innerHTML = value + '<br/>';
      }

      function variableChange(target) {
        const index = du.find.up('[index]', target).getAttribute('index');
        saved[index][target.getAttribute('name')] = target.value;
        du.cookie.set('values', saved);
        evaluate(target);
      }

      function loadValues() {
        const values = du.cookie.get('values');
        if (values) {
          try {
            saved = JSON.parse(values);
          } catch (e) {
            console.error('Error Loading Values\n', e);
          }
        }
      }

      function save() {
        const key = du.param.get('name');
        const value = du.param.get('token');
        const list = document.querySelectorAll('div[index]');
        const json = [];
        for (let index = 0; index < list.length; index += 1) {
          const name = list[index].querySelector('.name').value;
          const equation = list[index].querySelector('.equation').value;
          json.push({name, equation});
        }
        Request.post('/pssst/save/json', {group: 'custom-calc', key, value, json}, console.log, console.log);
      }

      function load() {
        function populate(body) {
          body.forEach((item) => addEq(item.name, item.equation));
        }
        const name = du.param.get('name');
        Request.get(`/pssst/load/json/custom-calc/${name}`, populate, console.error);
      }

      function onLoad() {
        const name = du.param.get('name');
        du.find('#name-cnt').innerText = name;
        const p = du.cookie.get('percision');
        percision = p === 'null' ? undefined : p;
        updatePercisionDisplay();
      }

      function canEdit() {
        const can = () => {
          du.find('#save-eqs-btn').hidden = false;
        }
        const cannot  = (e) => {
          console.log(e);
          const match = e.statusText.match(/(locked.*$)/);
          let errorMsg;
          if (match) {
            errorMsg = 'Your account has been ' + match[1];
          } else {
            errorMsg = "Invalid token: must fix if you want to edit file";
          }
          du.find('#error-cnt').innerText = errorMsg;
        }
        const token = du.param.get('token');
        if (token) {
          const name = du.param.get('name');
          Pssst.validateValue(can, cannot, 'custom-calc', name, token);
        }
      }

      function evaluateAll() {
        du.find.all('.equation').forEach(evaluate);
      }

      function setPercision (target) {
        percision = du.find.down('input', target).value;
        du.cookie.set('percision', percision);
        evaluateAll();
      }

      function updatePercision (target) {
        const percisionInputCnt = du.find.closest('.percision-input-cnt', target.parentElement);
        if (target.value === 'fraction') {
          setPercision(percisionInputCnt);
        } else if (target.value === 'decimal') {
          percision = undefined;
          du.cookie.set('percision', null);
          evaluateAll();
        }
        updatePercisionDisplay();
      }

      function updatePercisionDisplay () {
        const percisionInputCnt = du.find('.percision-input-cnt');
        if (percision === undefined) {
          percisionInputCnt.hidden = true;
          du.find('input[name="percision-selector"][value="decimal"]').checked = true;
        } else {
          percisionInputCnt.hidden = false;
          du.find('input[name="percision-selector"][value="fraction"]').checked = true;
          du.find.down('input', percisionInputCnt).value = percision;
        }
      }

      canEdit();
      loadValues();
      load();
      window.onload = onLoad;

      du.on.match('click', '#add-eq-btn', () => addEq());
      du.on.match('keyup', '.equation', updateVariables);
      du.on.match('keyup', `.${c}`, variableChange);
      du.on.match('click', '.equation', evaluate);
      du.on.match('click', `.${c}`, evaluate);
      du.on.match('click', '#save-eqs-btn', save);
      du.on.match('change', 'input[name="percision-selector"]', updatePercision);
      du.on.match('keyup', '.percision-input', setPercision);
      du.on.match('change', '.percision-input', setPercision);
    </script>
  </head>
  <body>
    <h2 id='name-cnt'></h2>
    <b id='error-cnt'></b>
    <div>
      <label>Decimal</label>
      <input type='radio' name='percision-selector' value='decimal'>
      <label>Fraction</label>
      <input type='radio' name='percision-selector' checked value='fraction'>
      <span class='percision-input-cnt'>
        <label>1/</label>
        <input type='number' class='percision-input' max='1000' min='1' name='percision' value='32'>
      </span>
    </div>
    <div id='eq-cnt'></div>
    <button id='add-eq-btn'>Add Equation</button>
    <button id='save-eqs-btn' hidden>Save</button>
  </body>
</html>
