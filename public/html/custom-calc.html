<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <script type="text/javascript" src='/js/utils/dom-utils.js'></script>
    <script type="text/javascript" src='/js/utils/utils.js'></script>
    <script type="text/javascript" src='/js/utils/measurment.js'></script>
    <script type="text/javascript" src='/js/utils/request.js'></script>
    <script type="text/javascript" src='/js/utils/string-math-evaluator.js'></script>
    <script type="text/javascript" src='/pssst/js/pssst-client.js'></script>
    <style>
      #error-cnt {
        color: red;
      }
      .percision-input {
        max-width: 30pt;
      }
      .full-width {
        width: 95vw;
        margin: 0 2vw;
      }
      .eq-input-elem {
        max-width: 45pt;
      }
      .calc-button {
        width: 25pt;
        height: 25pt;
      }
      .calc-button.wide {
        width: 35pt;
      }
      .calc-button.locked {
        background-color: #958b8b;
        font-weight: bolder;
        color: white;
      }
      .disable-zoom {
        touch-action: manipulation;
      }
    </style>
    <title>equations</title>
    <script type="text/javascript">
      let index = 1;
      const eval = new StringMathEvaluator(Math);
      function addEq(name, equation) {
        name = name || '';
        equation = equation || '';
        saved[index] = saved[index] || {};
        const newElem = du.create.element('div', {index: index});
        newElem.innerHTML = `<b>${index++}.)</b>
                              <input class='name' type='text' placeholder="Name" value='${name}'>
                              <br>
                              <input class='equation full-width disable-zoom' disabled type='text' placeholder="Equation" value='${equation}'>
                              <span class='input-cnt'></span>
                              <b>=</b>
                              <span class='answer-cnt'></span>
                              <br/>`;
        updateVariables(newElem.querySelector('.equation'));
        du.find('#eq-cnt').append(newElem);
      }

      function onlyUnique(value, index, self) {
        return self.indexOf(value) === index;
      }

      let saved = {};
      const c = 'eq-input-elem disable-zoom';

      function updateReferenceList() {
        const select = du.find('#reference-select');
        const indexes = Object.keys(saved);
        let html = '';
        html += `<option>Ref</option>`;
        for (let i = 0; i < indexes.length; i += 1) {
          const index = indexes[i];
          html += `<optgroup label="${index}">`
          html += `<option>=</option>`;
          const vars = Object.keys(saved[index]);
          for (let j = 0; j < vars.length; j += 1) {
            html += `<option>${vars[j]}</option>`;
          }
          html += '</optgroup>';
        }
        select.innerHTML = html;
      }

      function toggleDisabled(target) {
        target.disabled = !target.disabled;
        if (!target.disabled) hideCalcInput();
        else (setCalcInput(target));
      }

      function updateVariables(target) {
        let matches = target.value.match(/[a-z_A-Z][a-z_A-Z0-9]*/g);
        const varIndex = du.find.up('[index]', target).getAttribute('index');
        const inputCnt = du.find.closest('.input-cnt', target);
        if (matches) {
          matches = matches.filter(onlyUnique);
          let repeatHtml = '<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
          for (let index = 0; index < matches.length; index += 1) {
            const name = matches[index];
            const value = saved[varIndex][name] || 0;
            saved[varIndex][name] = value;
            const div = du.create.element('span');
            const b = du.create.element('b');
            b.innerText = name;
            div.append(b);
            div.append(du.create.element('input', {class: c, value, name, disabled: true}));
            repeatHtml += '&nbsp;' + div.outerHTML;
          }
          inputCnt.innerHTML = repeatHtml;
        } else {
          inputCnt.innerHTML = '';
        }
        evaluate(target);
        updateReferenceList();
      }

      function evalConnected(index) {
        const eqns = du.find.all('.equation');
        const refReg = new RegExp(`\\$\\(${index}\\)`);
        for (let i = 0; i < eqns.length; i += 1) {
          let eqnStr = eqns[i].value;
          const vars = du.find.downAll('.eq-input-elem', eqns[i]);
          for (let j = 0; j < vars; vars += 1) {
            eqnStr += vars.value;
          }
          if (eqnStr.match(refReg)) {
            evaluate(eqns[i]);
          }
        }
      }

      let answers = [];
      let percision = 32;

      const $ = (index, varName) => {
        if (varName === undefined) return answers[index] || 0;
        return Number.parseFloat(saved[index][varName] || 0);
      };
      function evaluate(target) {
        const index = du.find.up('[index]', target).getAttribute('index');
        const equation = du.find.closest('.equation', target).value;
        const inputCnt = du.find.closest(`.input-cnt`, target);
        const inputs = du.find.downAll('input', inputCnt);
        const scope = {$};
        for (let index = 0; index < inputs.length; index += 1) {
          const input = inputs[index];
          scope[input.name] = eval.eval(input.value, scope);
        }
        let value = eval.eval(equation, scope);
        if (percision !== undefined) {
          value = new Measurement(value).fraction(`1/${percision}`);
        }
        answers[index] = eval.eval(value);
        evalConnected(index);
        du.find.closest('.answer-cnt', target).innerHTML = value + '<br/>';
      }

      function variableChange(target) {
        const index = du.find.up('[index]', target).getAttribute('index');
        saved[index][target.getAttribute('name')] = target.value;
        du.cookie.set('values', saved);
        evaluate(target);
      }

      function loadValues() {
        const values = du.cookie.get('values');
        if (values) {
          try {
            saved = JSON.parse(values);
          } catch (e) {
            console.error('Error Loading Values\n', e);
          }
        }
      }

      function save() {
        const key = du.param.get('name');
        const value = du.param.get('token');
        const list = document.querySelectorAll('div[index]');
        const json = [];
        for (let index = 0; index < list.length; index += 1) {
          const name = list[index].querySelector('.name').value;
          const equation = list[index].querySelector('.equation').value;
          json.push({name, equation});
        }
        Request.post('/pssst/save/json', {group: 'custom-calc', key, value, json}, console.log, console.log);
      }

      function load() {
        function populate(body) {
          body.forEach((item) => addEq(item.name, item.equation));
        }
        const name = du.param.get('name');
        Request.get(`/pssst/load/json/custom-calc/${name}`, populate, console.error);
      }

      function onLoad() {
        const name = du.param.get('name');
        du.find('#name-cnt').innerText = name;
        const p = du.cookie.get('percision');
        percision = p === 'null' ? undefined : p;
        updatePercisionDisplay();
      }

      function canEdit() {
        const can = () => {
          du.find('#save-eqs-btn').hidden = false;
        }
        const cannot  = (e) => {
          console.log(e);
          const match = e.statusText.match(/(locked.*$)/);
          let errorMsg;
          if (match) {
            errorMsg = 'Your account has been ' + match[1];
          } else {
            errorMsg = "Invalid token: must fix if you want to edit file";
          }
          du.find('#error-cnt').innerText = errorMsg;
        }
        const token = du.param.get('token');
        if (token) {
          const name = du.param.get('name');
          Pssst.validateValue(can, cannot, 'custom-calc', name, token);
        }
      }

      function evaluateAll() {
        du.find.all('.equation').forEach(evaluate);
      }

      function setPercision (target) {
        percision = du.find.down('input', target).value;
        du.cookie.set('percision', percision);
        evaluateAll();
      }

      function updatePercision (target) {
        const percisionInputCnt = du.find.closest('.percision-input-cnt', target.parentElement);
        if (target.value === 'fraction') {
          setPercision(percisionInputCnt);
        } else if (target.value === 'decimal') {
          percision = undefined;
          du.cookie.set('percision', null);
          evaluateAll();
        }
        updatePercisionDisplay();
      }

      function updatePercisionDisplay () {
        const percisionInputCnt = du.find('.percision-input-cnt');
        if (percision === undefined) {
          percisionInputCnt.hidden = true;
          du.find('input[name="percision-selector"][value="decimal"]').checked = true;
        } else {
          percisionInputCnt.hidden = false;
          du.find('input[name="percision-selector"][value="fraction"]').checked = true;
          du.find.down('input', percisionInputCnt).value = percision;
        }
      }

      function hideCalcInput(target) {
        const calculator = du.find('#calc-input');
        calculator.hidden = true;
      }

      let calcInput;
      let calcState = 'numeric';
      let capState = 'lower';
      function setCalcInput(target, e) {
        if (e) e.stopPropagation();
        if (!target.disabled) return;
        const calculator = du.find('#calc-input');
        calculator.hidden = false;
        const numeric = du.find('.calc-input-table.numeric');
        const lower = du.find('.calc-input-table.lowercase');
        const upper = du.find('.calc-input-table.uppercase');
        calcInput = target;
        if (calcState === 'numeric') {
          lower.hidden = true;
          upper.hidden = true;
          numeric.hidden = false;
        } else {
          if (capState === 'lower') {
            lower.hidden = false;
            upper.hidden = true;
            numeric.hidden = true;

          } else {
            lower.hidden = true;
            upper.hidden = false;
            numeric.hidden = true;
          }
        }
        updateCapsIndicator();
        du.move.relitive(calculator, target, 'bottom');
      }

      function updateCapsIndicator() {
        const button = du.find('.calc-button.uppercase[type="caps"]');
        if (capState === 'lock') {
          du.class.add(button, 'locked');
        } else {
          du.class.remove(button, 'locked');
        }
      }

      function updateCalcInput(target, e) {
        e.stopPropagation();
        const type = target.getAttribute('type');
        switch (type) {
          case 'caps':
            if (capState === 'lower') capState = 'upper';
            else if (capState === 'upper') capState = 'lock';
            else if (capState === 'lock') capState = 'lower';
            setCalcInput(calcInput);
            break;
          case 'back':
            calcState = 'numeric';
            setCalcInput(calcInput);
            break;
          case 'alpha':
            calcState = 'alpha';
            setCalcInput(calcInput);
            break;
          case 'clear':
            calcInput.value = '';
            evaluate(calcInput);
            break;
          case 'space':
            calcInput.value += ' ';
            break;
          case 'delete':
            calcInput.value = calcInput.value.substr(0, calcInput.value.length - 1);
            evaluate(calcInput);
            break;
          case 'reference':
            console.log('referencing!')
            break;
         default:
            if (capState === 'upper') {
              capState = 'lower';
              setCalcInput(calcInput);
            }
            calcInput.value += target.innerText.trim();
            evaluate(calcInput);
        }
      }

      function applyReference(target) {
        const value = target.value;
        if (value === '') return;
        const selected = target.selectedOptions[0];
        const index = du.find.closest('optgroup', selected).label;
        if (value === 'Ref') {
          calcInput.value += `$(${index})`;
        } else {
          calcInput.value += `$(${index}, \'${value}\')`;
        }
        target.value = 'Ref';
      }

      canEdit();
      loadValues();
      load();
      window.onload = onLoad;

      du.on.match('click', '#add-eq-btn', () => addEq());
      du.on.match('keyup', '.equation', updateVariables);
      du.on.match('keyup', `.${c}`, variableChange);
      du.on.match('click', '.equation', evaluate);
      du.on.match('click', `.${c}`, evaluate);
      du.on.match('click', '#save-eqs-btn', save);
      du.on.match('change', 'input[name="percision-selector"]', updatePercision);
      du.on.match('keyup', '.percision-input', setPercision);
      du.on.match('change', '.percision-input', setPercision);
      du.on.match('click', '.eq-input-elem,.equation', setCalcInput);
      du.on.match('dblclick', '.eq-input-elem,.equation', toggleDisabled);
      du.on.match('click', '.calc-button', updateCalcInput);
      du.on.match('change', '#reference-select', applyReference);
      window.addEventListener('click', hideCalcInput);
    </script>
  </head>
  <body>
    <h2 id='name-cnt'></h2>
    <b id='error-cnt'></b>
    <div>
      <label>Decimal</label>
      <input type='radio' name='percision-selector' value='decimal'>
      <label>Fraction</label>
      <input type='radio' name='percision-selector' checked value='fraction'>
      <span class='percision-input-cnt'>
        <label>1/</label>
        <input type='number' class='percision-input' max='1000' min='1' name='percision' value='32'>
      </span>
    </div>
    <div id='eq-cnt'></div>
    <button id='add-eq-btn'>Add Equation</button>
    <button id='save-eqs-btn' hidden>Save</button>
    <div id='calc-input disable-zoom' hidden>
      <table class='calc-input-table numeric'>
        <tr>
          <td><button class='calc-button'>7</button></td>
          <td><button class='calc-button'>8</button></td>
          <td><button class='calc-button'>9</button></td>
          <td><button class='calc-button'>*</button></td>
          <td><button type='delete' class='calc-button wide'>Del</button></td>
          <td><button class='calc-button'>(</button></td>
        </tr>
        <tr>
          <td><button class='calc-button'>4</button></td>
          <td><button class='calc-button'>5</button></td>
          <td><button class='calc-button'>6</button></td>
          <td><button class='calc-button'>/</button></td>
          <td><select id='reference-select' type='reference' class='calc-button wide'></select></td>
          <td><button class='calc-button'>)</button></td>
        </tr>
        <tr>
          <td><button class='calc-button'>1</button></td>
          <td><button class='calc-button'>2</button></td>
          <td><button class='calc-button'>3</button></td>
          <td><button class='calc-button'>+</button></td>
          <td><button type='alpha' class='calc-button wide'>a-z</button></td>
        </tr>
        <tr>
          <td><button type='space' class='calc-button'>_</button></td>
          <td><button class='calc-button'>0</button></td>
          <td><button class='calc-button'>.</button></td>
          <td><button class='calc-button'>-</button></td>
          <td><button type='clear' class='calc-button wide'>Clear</button></td>
        </tr>
      </table>

      <table class='calc-input-table lowercase' hidden>
        <tr>
          <td><button type='back' class='calc-button'>&larr;</button></td>
          <td><button class='calc-button'>a</button></td>
          <td><button class='calc-button'>b</button></td>
          <td><button class='calc-button'>c</button></td>
          <td><button class='calc-button'>d</button></td>
          <td><button class='calc-button'>e</button></td>
          <td><button class='calc-button'>f</button></td>
        </tr>
        <tr>
          <td><button type='caps' class='calc-button'>&#8679;</button></td>
          <td><button class='calc-button'>g</button></td>
          <td><button class='calc-button'>h</button></td>
          <td><button class='calc-button'>i</button></td>
          <td><button class='calc-button'>j</button></td>
          <td><button class='calc-button'>k</button></td>
          <td><button class='calc-button'>l</button></td>
        </tr>
        <tr>
          <td><button class='calc-button'>m</button></td>
          <td><button class='calc-button'>n</button></td>
          <td><button class='calc-button'>o</button></td>
          <td><button class='calc-button'>p</button></td>
          <td><button class='calc-button'>q</button></td>
          <td><button class='calc-button'>r</button></td>
          <td><button class='calc-button'>s</button></td>
        </tr>
        <tr>
          <td><button class='calc-button'>t</button></td>
          <td><button class='calc-button'>u</button></td>
          <td><button class='calc-button'>v</button></td>
          <td><button class='calc-button'>w</button></td>
          <td><button class='calc-button'>x</button></td>
          <td><button class='calc-button'>y</button></td>
          <td><button class='calc-button'>z</button></td>
        </tr>
      </table>

      <table class='calc-input-table uppercase' hidden>
        <tr>
          <td><button type='back' class='calc-button'>&larr;</button></td>
          <td><button class='calc-button'>A</button></td>
          <td><button class='calc-button'>B</button></td>
          <td><button class='calc-button'>C</button></td>
          <td><button class='calc-button'>D</button></td>
          <td><button class='calc-button'>E</button></td>
          <td><button class='calc-button'>F</button></td>
        </tr>
        <tr>
          <td><button type='caps' class='calc-button uppercase'>&#8679;</button></td>
          <td><button class='calc-button'>G</button></td>
          <td><button class='calc-button'>H</button></td>
          <td><button class='calc-button'>I</button></td>
          <td><button class='calc-button'>J</button></td>
          <td><button class='calc-button'>K</button></td>
          <td><button class='calc-button'>L</button></td>
        </tr>
        <tr>
          <td><button class='calc-button'>M</button></td>
          <td><button class='calc-button'>N</button></td>
          <td><button class='calc-button'>O</button></td>
          <td><button class='calc-button'>P</button></td>
          <td><button class='calc-button'>Q</button></td>
          <td><button class='calc-button'>R</button></td>
          <td><button class='calc-button'>S</button></td>
        </tr>
        <tr>
          <td><button class='calc-button'>T</button></td>
          <td><button class='calc-button'>U</button></td>
          <td><button class='calc-button'>V</button></td>
          <td><button class='calc-button'>W</button></td>
          <td><button class='calc-button'>X</button></td>
          <td><button class='calc-button'>Y</button></td>
          <td><button class='calc-button'>Z</button></td>
        </tr>
      </div>
    </table>
  </body>
</html>
