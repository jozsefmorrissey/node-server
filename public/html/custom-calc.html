<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <script type="text/javascript" src='/js/utils/dom-utils.js'></script>
    <script type="text/javascript" src='/js/utils/utils.js'></script>
    <script type="text/javascript" src='/js/utils/object/lookup.js'></script>
    <script type="text/javascript" src='/js/utils/string-math-evaluator.js'></script>
    <script type="text/javascript" src='/js/utils/measurement.js'></script>
    <script type="text/javascript" src='/js/utils/request.js'></script>
    <script type="text/javascript" src='/pssst/js/pssst-client.js'></script>
    <style>
    @media only screen
      and (max-device-width: 600px) {
        input,label,b {
          font-size: 20pt;
        }
      }
      .error-cnt {
        color: red;
      }
      .percision-input {
        max-width: 30pt;
      }
      .full-width {
        width: 95vw;
        margin: 0 2vw;
      }
      .eq-input-elem {
        max-width: 45pt;
      }
      #calc-input {
        position: absolute;
        z-index: 12;
      }
      .calc-button {
        font-size: 20pt;
        width: 35pt;
        height: 35pt;
      }
      .calc-button.wide {
        width: 55pt;
      }
      .calc-button.locked {
        background-color: #958b8b;
        font-weight: bolder;
        color: white;
      }
      .disable-zoom {
        touch-action: manipulation;
      }
      #link-menu {
        display: flex;
        list-style-type: none;
      }
      #link-menu > li {
        padding: 5pt;
        font-size: x-large;
      }
      .remove-link-cnt {
        display: flex;
      }
      .remove-link-btn {
        margin: auto;
        padding: 0 2pt;
        border-radius: 5pt;
        display: none;
      }
      .remove-cnt {
        position: relative;
        background-color: white;
        margin: 2pt;
        z-index: 10;
      }

      .pop-up-haze {
        position: fixed;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        text-align: center;
        background: rgba(0,0,0,0.6);
        padding: 5vh 1vw;
        z-index: 9;
        /* display: none; */
      }
    </style>
    <title>equations</title>
    <script type="text/javascript">
      let index = 1;
      const eval = new StringMathEvaluator(Math);
      function addEq(name, equation) {
        name = name || '';
        equation = equation || '';
        saved[index] = saved[index] || {};
        const newElem = du.create.element('div', {index: index, class: 'remove-cnt eqn'});
        newElem.innerHTML = `<b>${index++}.)</b>
                              <input class='name' type='text' placeholder="Name" value='${name}'>
                              <br>
                              <input class='equation full-width disable-zoom' ${eqnDisabled ? 'disabled ' : ''}type='text' placeholder="Equation" value='${equation}'>
                              <div class='error-cnt'></div>
                              <span class='input-cnt'></span>
                              <b>=</b>
                              <b class='answer-cnt'></b>
                              <br/>`;
        updateVariables(newElem.querySelector('.equation'));
        du.find('#eq-cnt').append(newElem);
      }

      function onlyUnique(value, index, self) {
        return self.indexOf(value) === index;
      }

      let homeSaved;
      let saved = {};
      links = [];
      const c = 'eq-input-elem disable-zoom';

      function buildLink(name) {
        return `<li class='remove-cnt link'><a href='#' onclick='load("${name}")'>${name}</a><br><div class='remove-link-cnt'><button class='remove-link-btn'>X</button></div></li>`
      }

      let removing = false;
      function removeToggle() {
        const haze = du.find('.pop-up-haze');
        haze.hidden = !haze.hidden;
        removing = !haze.hidden;
      }

      function remove(elem) {
        if (removing) {
          if (elem.matches('.link')) {
            const name = du.find.closest('a', elem).innerText;
            links.splice(links.indexOf(name), 1);
            buildLinks();
          } else if (elem.matches('.eqn')){
            elem.remove();
          }
        }
      }

      function buildLinks() {
        let linkHtml = `<li><a href='#' onclick='load()'>Home</a></li>`;
        links.forEach((name) => linkHtml += buildLink(name));
        linkHtml += '<li><input type="text" id="add-link-input"><button id="add-link-btn">+</button></li>'
        du.find('#link-menu').innerHTML = linkHtml;
      }

      function addLink(target) {
        links.push(du.find.closest('input', target).value);
        buildLinks();
      }

      function updateReferenceList() {
        const select = du.find('#reference-select');
        const indexes = Object.keys(saved);
        let html = '';
        html += `<option>Ref</option>`;
        for (let i = 0; i < indexes.length; i += 1) {
          const index = indexes[i];
          html += `<option index='${index}'><b>${index}</b></option>`;
          const vars = Object.keys(saved[index]);
          for (let j = 0; j < vars.length; j += 1) {
            html += `<option index='${index}'>&nbsp;&nbsp;&nbsp;&nbsp;${vars[j]}</option>`;
          }
        }
        select.innerHTML = html;
      }

      let varDisabled = (du.cookie.get('eqn-input') || '').match(/var=true/) ? true : false;
      let eqnDisabled = (du.cookie.get('eqn-input') || '').match(/eqn=true/) ? true : false;
      function toggleDisabled(target) {
        const selector = '.' + target.className.replace(/ /g, '.');
        const elems = du.find.all(selector);
        elems.forEach((elem) => {
          elem.disabled = !elem.disabled;
          if (!elem.disabled) {
            hideCalcInput();
            elem.focus();
            elem.select();
          } else {
            setCalcInput(elem);
          };
        });
        if (target.matches('.equation')) eqnDisabled = target.disabled;
        if (target.matches('.eq-input-elem')) varDisabled = target.disabled;
        du.cookie.set('eqn-input', `eqn=${eqnDisabled}:var=${varDisabled}`);
      }

      function getVars(index) {
        return Object.keys(saved[index] || []);
      }

      function updateVariables(target) {
        const clean = target.value.replace(/\$\(.*?\)/g, '');
        let matches = clean.match(/[a-z_A-Z][a-z_A-Z0-9]*/g);
        const varIndex = du.find.up('[index]', target).getAttribute('index');
        const inputCnt = du.find.closest('.input-cnt', target);
        if (matches) {
          matches = matches.filter(onlyUnique);
          let repeatHtml = '<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
          const newSaved = {};
          for (let index = 0; index < matches.length; index += 1) {
            const name = matches[index];
            const value = saved[varIndex][name] || 0;
            newSaved[name] = value;
            const div = du.create.element('span');
            const b = du.create.element('b');
            b.innerText = name;
            div.append(b);
            const input = du.create.element('input', {class: c, value, name});
            input.disabled = varDisabled === true ? true : undefined;
            div.append(input);
            repeatHtml += '&nbsp;' + div.outerHTML;
          }
          saved[varIndex] = newSaved;
          inputCnt.innerHTML = repeatHtml;
        } else {
          saved[varIndex] = {};
          inputCnt.innerHTML = '';
        }
        evaluate(target);
        updateReferenceList();
      }

      function shouldEvaluate(eqn, index, otherEqn, otherIndex) {
        if (eqn === otherEqn) return false
        if (eqn.match(new RegExp(`\\$\\(${index}\\)`))) return true;
        const refReg = (varName)  => new RegExp(`\\$\\(${index}(|,\\s*("|')${varName}("|'))\\)`);
        const vars = getVars(index);
        for (let j = 0; j < vars.length; j += 1) {
          const eqnStr = buildEquationStr(otherEqn, otherIndex);
          if (eqnStr.match(refReg(vars[j]))) {
            return true;
          }
        }
        return false;
      }

      function buildEquationStr(eqn, index) {
        let eqnStr = eqn;
        const vars = getVars(index);
        for (let i = 0; i < vars.length; i += 1) {
          eqnStr += saved[index][vars[i]];
        }
        return eqnStr;
      }

      function evalConnected(index) {
        const eqns = du.find.all('.equation');
        const eqn = eqns[index - 1];
        if (eqn) {
          const eval = [];
          eqns.forEach((otherEqn, otherIndex) => {
            if (shouldEvaluate(eqn.value, index, otherEqn.value, otherIndex + 1)) {
              eval.push(otherEqn);
            }
          });
          eval.forEach((eqn) => evaluate(eqn));
        }
      }

      let answers = [];
      let percision = 32;

      const $ = (index, varName) => {
        if (varName === undefined) return answers[index] || 0;
        return eval.eval(saved[index][varName], {$});
      };
      function evaluate(target) {
        const index = du.find.up('[index]', target).getAttribute('index');
        const equation = du.find.closest('.equation', target).value;
        const inputCnt = du.find.closest(`.input-cnt`, target);
        const inputs = du.find.downAll('input', inputCnt);
        const scope = {$};
        for (let index = 0; index < inputs.length; index += 1) {
          const input = inputs[index];
          scope[input.name] = eval.eval(input.value, scope);
        }
        const errorCnt = du.find.closest('.error-cnt', target);
        try {
          let value = eval.eval(equation, scope);
          if (!Number.isNaN(value)) {
            if (percision !== undefined) {
              value = new Measurement(value).fraction(`1/${percision}`);
            }
            answers[index] = eval.eval(value);
            evalConnected(index);
            du.find.closest('.answer-cnt', target).innerHTML = value + '<br/>';
            errorCnt.innerText = "";
            return;
          }
        } catch (e) {
          console.error(e);
        }
        errorCnt.innerText = "Equation cannot be evaluated.";
      }

      function variableChange(target) {
        const index = du.find.up('[index]', target).getAttribute('index');
        saved[index][target.getAttribute('name')] = target.value;
        du.cookie.set('values', saved);
        evaluate(target);
      }

      function loadValues() {
        const values = du.cookie.get('values');
        if (values) {
          try {
            saved = JSON.parse(values);
          } catch (e) {
            console.error('Error Loading Values\n', e);
          }
        }
      }

      function stateObject () {
        const list = document.querySelectorAll('div[index]');
        const json = {equations: [], links};
        for (let index = 0; index < list.length; index += 1) {
          const name = list[index].querySelector('.name').value;
          const equation = list[index].querySelector('.equation').value;
          json.equations.push({name, equation});
        }
        return json;
      }

      function save() {
        const key = du.param.get('name');
        const value = du.param.get('token');
        const json = stateObject();
        Request.post('/pssst/save/json', {group: 'custom-calc', key, value, json}, console.log, console.log);
      }

      let initialLoad = true;
      let isHome;
      function load(name) {
        function populate(body) {
          if (name) {
            du.find.all('.modify-data').forEach((elem) => elem.hidden = true);
          } else {
            du.find.all('.modify-data').forEach((elem) => elem.hidden = false);
          }
          du.find('#eq-cnt').innerHTML = '';
          index = 1;
          if (Array.isArray(body.equations)) {
            body.equations.forEach((item) => addEq(item.name, item.equation));
            if (initialLoad) {
              initialLoad = false;
              links = body.links;
              buildLinks();
            }
          }
        }
        if (initialLoad && name === undefined) {
          Request.get(`/pssst/load/json/custom-calc/${du.param.get('name')}`, populate, console.error);
          isHome = true;
        } else if (name) {
          if (isHome) homeSaved = stateObject().equations;
          console.log(stateObject());
          Request.get(`/pssst/load/json/custom-calc/${name}`, populate, console.error);
          isHome = false;
          du.find('#name-cnt').innerText = name;
        } else {
          isHome = true;
          populate({equations: homeSaved});
          du.find('#name-cnt').innerText = du.param.get('name');
        }
      }

      function onLoad() {
        const name = du.param.get('name');
        du.find('#name-cnt').innerText = du.param.get('name');
        const p = du.cookie.get('percision');
        percision = p === 'null' ? undefined : p;
        updatePercisionDisplay();
      }

      function canEdit() {
        const can = () => {
          du.find('#save-eqs-btn').hidden = false;
        }
        const cannot  = (e) => {
          console.log(e);
          const match = e.statusText.match(/(locked.*$)/);
          let errorMsg;
          if (match) {
            errorMsg = 'Your account has been ' + match[1];
          } else {
            errorMsg = "Invalid token: must fix if you want to save changes";
          }
          du.find('#error-cnt').innerText = errorMsg;
        }
        const token = du.param.get('token');
        if (token) {
          const name = du.param.get('name');
          Pssst.validateValue(can, cannot, 'custom-calc', name, token);
        }
      }

      function evaluateAll() {
        du.find.all('.equation').forEach(evaluate);
      }

      function setPercision (target) {
        percision = du.find.down('input', target).value;
        du.cookie.set('percision', percision);
        evaluateAll();
      }

      function updatePercision (target) {
        const percisionInputCnt = du.find.closest('.percision-input-cnt', target.parentElement);
        if (target.value === 'fraction') {
          setPercision(percisionInputCnt);
        } else if (target.value === 'decimal') {
          percision = undefined;
          du.cookie.set('percision', null);
          evaluateAll();
        }
        updatePercisionDisplay();
      }

      function updatePercisionDisplay () {
        const percisionInputCnt = du.find('.percision-input-cnt');
        if (percision === undefined) {
          percisionInputCnt.hidden = true;
          du.find('input[name="percision-selector"][value="decimal"]').checked = true;
        } else {
          percisionInputCnt.hidden = false;
          du.find('input[name="percision-selector"][value="fraction"]').checked = true;
          du.find.down('input', percisionInputCnt).value = percision;
        }
      }

      function hideCalcInput(target) {
        const calculator = du.find('#calc-input');
        calculator.hidden = true;
      }

      let calcInput;
      let calcState = 'numeric';
      let capState = 'lower';
      function setCalcInput(target, e) {
        if (e) e.stopPropagation();
        if (!target.disabled) return;
        const calculator = du.find('#calc-input');
        calculator.hidden = false;
        const numeric = du.find('.calc-input-table.numeric');
        const lower = du.find('.calc-input-table.lowercase');
        const upper = du.find('.calc-input-table.uppercase');
        calcInput = target;
        if (calcState === 'numeric') {
          lower.hidden = true;
          upper.hidden = true;
          numeric.hidden = false;
        } else {
          if (capState === 'lower') {
            lower.hidden = false;
            upper.hidden = true;
            numeric.hidden = true;

          } else {
            lower.hidden = true;
            upper.hidden = false;
            numeric.hidden = true;
          }
        }
        updateCapsIndicator();
        du.move.relitive(calculator, target, 'bottom');
      }

      function updateCapsIndicator() {
        const button = du.find('.calc-button.uppercase[type="caps"]');
        if (capState === 'lock') {
          du.class.add(button, 'locked');
        } else {
          du.class.remove(button, 'locked');
        }
      }

      function updateCalcInput(target, e) {
        e.stopPropagation();
        const type = target.getAttribute('type');
        switch (type) {
          case 'caps':
            if (capState === 'lower') capState = 'upper';
            else if (capState === 'upper') capState = 'lock';
            else if (capState === 'lock') capState = 'lower';
            setCalcInput(calcInput);
            break;
          case 'back':
            calcState = 'numeric';
            setCalcInput(calcInput);
            break;
          case 'alpha':
            calcState = 'alpha';
            setCalcInput(calcInput);
            break;
          case 'clear':
            calcInput.value = '';
            evaluate(calcInput);
            break;
          case 'space':
            calcInput.value += ' ';
            break;
          case 'delete':
            calcInput.value = calcInput.value.substr(0, calcInput.value.length - 1);
            evaluate(calcInput);
            break;
          case 'reference':
            console.log('referencing!')
            break;
         default:
            if (capState === 'upper') {
              capState = 'lower';
              setCalcInput(calcInput);
            }
            calcInput.value += target.innerText.trim();
            evaluate(calcInput);
        }
        if (calcInput.matches('.eq-input-elem')) variableChange(calcInput);
      }

      function applyReference(target) {
        const value = target.value.trim();
        if (value === '') return;
        const selected = target.selectedOptions[0];
        const index = selected.getAttribute('index');
        if (value === index) {
          calcInput.value += `$(${index})`;
        } else {
          calcInput.value += `$(${index}, \'${value}\')`;
        }
        target.value = 'Ref';
        evaluate(calcInput);
      }

      canEdit();
      loadValues();
      load();
      window.onload = onLoad;

      du.on.match('click', '#add-eq-btn', () => addEq());
      du.on.match('keyup', '.equation', updateVariables);
      du.on.match('keyup', `.eq-input-elem`, variableChange);
      du.on.match('change', `.eq-input-elem`, variableChange);
      du.on.match('click', '.equation', evaluate);
      du.on.match('click', `.eq-input-elem`, evaluate);
      du.on.match('click', '#save-eqs-btn', save);
      du.on.match('change', 'input[name="percision-selector"]', updatePercision);
      du.on.match('keyup', '.percision-input', setPercision);
      du.on.match('change', '.percision-input', setPercision);
      du.on.match('click', '.eq-input-elem,.equation', setCalcInput);
      du.on.match('dblclick', '.eq-input-elem,.equation', toggleDisabled);
      du.on.match('click', '.calc-button', updateCalcInput);
      du.on.match('change', '#reference-select', applyReference);
      du.on.match('click', '#add-link-btn', addLink);
      du.on.match('enter', '#add-link-input', addLink);
      du.on.match('click', '.pop-up-haze', removeToggle);
      du.on.match('click', '#remove-btn', removeToggle);
      du.on.match('click', '.remove-cnt', remove);
      window.addEventListener('click', hideCalcInput);
    </script>
  </head>
  <body>
    <div>
      <ul id='link-menu'></ul>
    </div>
    <h2 id='name-cnt'></h2>
    <b id='error-cnt' class='error-cnt'></b>
    <div>
      <label>Decimal</label>
      <input type='radio' name='percision-selector' value='decimal'>
      <label>Fraction</label>
      <input type='radio' name='percision-selector' checked value='fraction'>
      <span class='percision-input-cnt'>
        <label>1/</label>
        <input type='number' class='percision-input' max='1000' min='1' name='percision' value='32'>
      </span>
      <button class='modify-data' id='remove-btn'>Remove</button>
    </div>
    <div id='eq-cnt'></div>
    <span class='modify-data'>
      <button id='add-eq-btn'>Add Equation</button>
      <button id='save-eqs-btn' hidden>Save</button>
    </span>
    <div class='pop-up-haze' hidden></div>
    <div id='calc-input' class='disable-zoom' hidden>
      <table class='calc-input-table numeric'>
        <tr>
          <td><button class='calc-button'>7</button></td>
          <td><button class='calc-button'>8</button></td>
          <td><button class='calc-button'>9</button></td>
          <td><button class='calc-button'>*</button></td>
          <td><button type='delete' class='calc-button wide'>Del</button></td>
          <td><button class='calc-button'>(</button></td>
        </tr>
        <tr>
          <td><button class='calc-button'>4</button></td>
          <td><button class='calc-button'>5</button></td>
          <td><button class='calc-button'>6</button></td>
          <td><button class='calc-button'>/</button></td>
          <td><select id='reference-select' type='reference' class='calc-button wide'></select></td>
          <td><button class='calc-button'>)</button></td>
        </tr>
        <tr>
          <td><button class='calc-button'>1</button></td>
          <td><button class='calc-button'>2</button></td>
          <td><button class='calc-button'>3</button></td>
          <td><button class='calc-button'>+</button></td>
          <td><button type='alpha' class='calc-button wide'>a-z</button></td>
        </tr>
        <tr>
          <td><button type='space' class='calc-button'>_</button></td>
          <td><button class='calc-button'>0</button></td>
          <td><button class='calc-button'>.</button></td>
          <td><button class='calc-button'>-</button></td>
          <td><button type='clear' class='calc-button wide'>Clear</button></td>
        </tr>
      </table>

      <table class='calc-input-table lowercase' hidden>
        <tr>
          <td><button type='back' class='calc-button'>&larr;</button></td>
          <td><button class='calc-button'>a</button></td>
          <td><button class='calc-button'>b</button></td>
          <td><button class='calc-button'>c</button></td>
          <td><button class='calc-button'>d</button></td>
          <td><button class='calc-button'>e</button></td>
          <td><button class='calc-button'>f</button></td>
        </tr>
        <tr>
          <td><button type='caps' class='calc-button'>&#8679;</button></td>
          <td><button class='calc-button'>g</button></td>
          <td><button class='calc-button'>h</button></td>
          <td><button class='calc-button'>i</button></td>
          <td><button class='calc-button'>j</button></td>
          <td><button class='calc-button'>k</button></td>
          <td><button class='calc-button'>l</button></td>
        </tr>
        <tr>
          <td><button class='calc-button'>m</button></td>
          <td><button class='calc-button'>n</button></td>
          <td><button class='calc-button'>o</button></td>
          <td><button class='calc-button'>p</button></td>
          <td><button class='calc-button'>q</button></td>
          <td><button class='calc-button'>r</button></td>
          <td><button class='calc-button'>s</button></td>
        </tr>
        <tr>
          <td><button class='calc-button'>t</button></td>
          <td><button class='calc-button'>u</button></td>
          <td><button class='calc-button'>v</button></td>
          <td><button class='calc-button'>w</button></td>
          <td><button class='calc-button'>x</button></td>
          <td><button class='calc-button'>y</button></td>
          <td><button class='calc-button'>z</button></td>
        </tr>
      </table>

      <table class='calc-input-table uppercase' hidden>
        <tr>
          <td><button type='back' class='calc-button'>&larr;</button></td>
          <td><button class='calc-button'>A</button></td>
          <td><button class='calc-button'>B</button></td>
          <td><button class='calc-button'>C</button></td>
          <td><button class='calc-button'>D</button></td>
          <td><button class='calc-button'>E</button></td>
          <td><button class='calc-button'>F</button></td>
        </tr>
        <tr>
          <td><button type='caps' class='calc-button uppercase'>&#8679;</button></td>
          <td><button class='calc-button'>G</button></td>
          <td><button class='calc-button'>H</button></td>
          <td><button class='calc-button'>I</button></td>
          <td><button class='calc-button'>J</button></td>
          <td><button class='calc-button'>K</button></td>
          <td><button class='calc-button'>L</button></td>
        </tr>
        <tr>
          <td><button class='calc-button'>M</button></td>
          <td><button class='calc-button'>N</button></td>
          <td><button class='calc-button'>O</button></td>
          <td><button class='calc-button'>P</button></td>
          <td><button class='calc-button'>Q</button></td>
          <td><button class='calc-button'>R</button></td>
          <td><button class='calc-button'>S</button></td>
        </tr>
        <tr>
          <td><button class='calc-button'>T</button></td>
          <td><button class='calc-button'>U</button></td>
          <td><button class='calc-button'>V</button></td>
          <td><button class='calc-button'>W</button></td>
          <td><button class='calc-button'>X</button></td>
          <td><button class='calc-button'>Y</button></td>
          <td><button class='calc-button'>Z</button></td>
        </tr>
      </div>
    </table>
  </body>
</html>
